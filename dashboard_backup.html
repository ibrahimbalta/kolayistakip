<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kolay İş Takip - Panel</title>
    <link rel="stylesheet" href="dashboard.css" />
    <link rel="stylesheet" href="task-list-scroll.css" />
    <link rel="stylesheet" href="dashboard-mobile.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <!-- Chart.js for advanced charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

</head>

<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fa-solid fa-layer-group"></i>
                    Kolay İş Takip
                </div>
            </div>
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="user-info">
                    <div id="userNameDisplay" class="user-name">Kullanıcı</div>
                    <div class="user-role">Yönetici</div>
                </div>
            </div>
            <nav class="menu">
                <a href="#" class="menu-item active" onclick="switchView('tasks')">
                    <i class="fa-solid fa-list-check"></i> İş Listesi
                </a>
                <a href="#" class="menu-item" onclick="switchView('appointments')">
                    <i class="fa-solid fa-calendar-check"></i> Randevular
                </a>
                <a href="#" class="menu-item" onclick="switchView('proposals')">
                    <i class="fa-solid fa-file-invoice-dollar"></i> Teklifler
                </a>
                <a href="#" class="menu-item" onclick="switchView('employees')">
                    <i class="fa-solid fa-users"></i> Çalışanlar
                </a>
                <a href="#" class="menu-item" onclick="switchView('reports')">
                    <i class="fa-solid fa-chart-pie"></i> Raporlar
                </a>
                <a href="#" class="menu-item" onclick="switchView('settings')">
                    <i class="fa-solid fa-gear"></i> Ayarlar
                </a>
            </nav>
            <button onclick="Auth.logout()" class="logout-btn">
                <i class="fa-solid fa-right-from-bracket"></i> Çıkış Yap
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header-bar">
                <div class="page-title">
                    <h1 id="pageTitle">Panel</h1>
                    <p id="pageSubtitle">Bugünün işlerini organize et.</p>
                </div>
                <div id="trialBadge" class="trial-badge">
                    <i class="fa-regular fa-clock"></i> Deneme Sürümü
                </div>
            </header>

            <!-- VIEW: TASKS -->
            <section id="view-tasks" class="view-section">
                <div class="task-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">Toplam İş</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingTasks" style="color:var(--warning);">0</div>
                        <div class="stat-label">Bekleyen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedTasks" style="color:var(--success);">0</div>
                        <div class="stat-label">Tamamlanan</div>
                    </div>
                </div>
                <div class="content-grid">
                    <!-- Add Task Form -->
                    <div class="card">
                        <h2><i class="fa-solid fa-plus-circle" style="color: var(--primary);"></i> Yeni İş Ekle</h2>
                        <form id="taskForm">
                            <div class="form-group">
                                <label for="taskDesc">Yapılacak İş</label>
                                <textarea id="taskDesc" placeholder="Örn: Müşteri X'in siparişini hazırla..." required
                                    style="min-height:100px; resize:vertical;"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="employeeSelect">Çalışan Seç</label>
                                <select id="employeeSelect" required>
                                    <option value="">Çalışan Seçin...</option>
                                </select>
                                <div style="margin-top:8px; font-size:0.85rem; color:var(--secondary);">
                                    Listede yok mu? <a href="#" onclick="switchView('employees')"
                                        style="color:var(--primary); font-weight:600;">Yeni Çalışan Ekle</a>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">
                                <i class="fa-solid fa-paper-plane"></i> İşi Ata ve Gönder
                            </button>
                        </form>
                    </div>
                    <!-- Task List -->
                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                            <h2><i class="fa-solid fa-list-ul" style="color: var(--primary);"></i> Görevler</h2>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">Tümü</button>
                                <button class="filter-btn" data-filter="pending">Bekleyen</button>
                                <button class="filter-btn" data-filter="completed">Tamamlanan</button>
                            </div>
                        </div>
                        <div id="taskList" class="task-list">
                            <div class="empty-state" style="text-align:center; padding:3rem 0; color:var(--secondary);">
                                <i class="fa-solid fa-clipboard-list"
                                    style="font-size:3rem; margin-bottom:1rem; opacity:0.3;"></i>
                                <p>Henüz kayıtlı iş yok.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- VIEW: APPOINTMENTS -->
            <section id="view-appointments" class="view-section" style="display:none;">
                <!-- Stats -->
                <div class="task-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSlots">0</div>
                        <div class="stat-label">Toplam Slot</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="availableSlots" style="color:var(--success);">0</div>
                        <div class="stat-label">Müsait</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="reservedSlots" style="color:var(--primary);">0</div>
                        <div class="stat-label">Rezerve</div>
                    </div>
                </div>
                <div class="content-grid">
                    <!-- Calendar -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                            <h2><i class="fa-solid fa-calendar-days" style="color: var(--primary);"></i> Randevu Takvimi
                            </h2>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="shareViaWhatsApp()" class="btn btn-primary">
                                    <i class="fa-brands fa-whatsapp"></i> WhatsApp ile Paylaş
                                </button>
                            </div>
                        </div>

                        <!-- Share Link -->
                        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                            <input type="text" id="shareLink" readonly
                                style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: #f9fafb;"
                                placeholder="Takvim yükleniyor...">
                            <button onclick="copyShareLink()" class="btn"
                                style="background: var(--primary); color: white;">
                                <i class="fa-solid fa-copy"></i> Kopyala
                            </button>
                        </div>
                        <!-- Calendar Container -->
                        <div id="appointmentCalendar"></div>

                        <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <p style="margin: 0; color: var(--secondary); font-size: 0.9rem;">
                                <i class="fa-solid fa-info-circle"></i>
                                <strong>Kullanım:</strong> Takvimde bir zaman dilimi seçerek müsait saat ekleyin.
                                Yeşil: Müsait, Mavi: Rezerve edilmiş. Randevulara tıklayarak detayları görebilirsiniz.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: PROPOSALS -->
            <section id="view-proposals" class="view-section" style="display:none;">
                <div class="task-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProposals">0</div>
                        <div class="stat-label">Toplam Teklif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="approvedProposals" style="color:var(--success);">0</div>
                        <div class="stat-label">Onaylanan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingProposals" style="color:var(--warning);">0</div>
                        <div class="stat-label">Bekleyen</div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                            <h2><i class="fa-solid fa-file-invoice-dollar" style="color: var(--primary);"></i> Teklifler
                            </h2>
                            <button onclick="openProposalModal()" class="btn btn-primary">
                                <i class="fa-solid fa-plus"></i> Yeni Teklif Oluştur
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Müşteri</th>
                                        <th>Başlık</th>
                                        <th>Tutar</th>
                                        <th>Durum</th>
                                        <th>Tarih</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="proposalListBody">
                                    <tr>
                                        <td colspan="6" style="text-align:center; color:var(--secondary);">Henüz teklif
                                            yok.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <!-- VIEW: EMPLOYEES -->
            <section id="view-employees" class="view-section" style="display:none;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                        <h2><i class="fa-solid fa-users" style="color: var(--primary);"></i> Çalışan Listesi</h2>
                        <button onclick="showAddEmployeeModal()" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i> Yeni Çalışan
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Telefon</th>
                                    <th>Aktif Görevler</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="employeeListBody">
                                <tr>
                                    <td colspan="4" style="text-align:center; color:var(--secondary);">Henüz çalışan
                                        eklenmemiş.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: REPORTS -->
            <section id="view-reports" class="view-section" style="display:none;">
                <!-- Export Toolbar -->
                <div class="export-toolbar">
                    <button onclick="exportToExcel()" class="btn btn-export">
                        <i class="fa-solid fa-file-excel"></i> Excel İndir
                    </button>
                    <button onclick="exportToPDF()" class="btn btn-export">
                        <i class="fa-solid fa-file-pdf"></i> PDF İndir
                    </button>
                </div>

                <!-- Performance Cards -->
                <div class="performance-cards-grid" id="performanceCards">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Completion Rate Chart -->
                    <div class="card">
                        <h2><i class="fa-solid fa-chart-pie" style="color: var(--primary);"></i> Tamamlanma Oranı</h2>
                        <div class="chart-wrapper">
                            <canvas id="completionChart"></canvas>
                        </div>
                        <div id="completionStats" class="chart-stats"></div>
                    </div>

                    <!-- Productivity Trend Chart -->
                    <div class="card">
                        <h2><i class="fa-solid fa-chart-line" style="color: var(--success);"></i> Verimlilik Trendi (Son
                            7 Gün)</h2>
                        <div class="chart-wrapper">
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Employee Performance Table -->
                <div class="card">
                    <h2><i class="fa-solid fa-ranking-star" style="color: var(--warning);"></i> Çalışan Performans
                        Detayları</h2>
                    <div class="table-responsive">
                        <table class="data-table analytics-table" id="performanceTable">
                            <thead>
                                <tr>
                                    <th>Çalışan</th>
                                    <th>Toplam Görev</th>
                                    <th>Tamamlanan</th>
                                    <th>Bekleyen</th>
                                    <th>Tamamlanma Oranı</th>
                                    <th>Performans Skoru</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <tr>
                                    <td colspan="6" style="text-align:center; color:var(--secondary);">Henüz veri yok.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: SETTINGS -->
            <section id="view-settings" class="view-section" style="display:none;">
                <div class="card" style="max-width:600px; margin:0 auto;">
                    <h2><i class="fa-solid fa-gear" style="color: var(--secondary);"></i> Ayarlar</h2>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label>Firma Adı</label>
                            <input type="text" id="settingCompanyName" />
                        </div>
                        <div class="form-group">
                            <label>Kullanıcı Adı</label>
                            <input type="text" id="settingEmail" disabled style="background:#f1f5f9;" />
                        </div>
                        <div class="form-group">
                            <label>Yeni Şifre (Değiştirmek için doldurun)</label>
                            <input type="password" id="settingNewPassword" placeholder="Yeni şifrenizi girin" />
                        </div>
                        <div class="form-group">
                            <label>Yeni Şifre Tekrar</label>
                            <input type="password" id="settingConfirmPassword"
                                placeholder="Yeni şifrenizi tekrar girin" />
                        </div>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </form>
                    <hr style="margin:2rem 0; border:0; border-top:1px solid var(--border);" />
                    <div style="background:#fef2f2; padding:1.5rem; border-radius:12px; border:1px solid #fecaca;">
                        <h3 style="color:#991b1b; font-size:1.1rem; margin-bottom:0.5rem;">Tehlikeli Bölge</h3>
                        <p style="color:#b91c1c; font-size:0.9rem; margin-bottom:1rem;">Tüm verilerinizi (görevler,
                            çalışanlar) kalıcı olarak siler.</p>
                        <button onclick="clearAllData()" class="btn btn-delete" style="width:auto;">Verileri
                            Sıfırla</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal-overlay" style="display:none;">
        <div class="modal-content card">
            <h2 style="margin-bottom:1.5rem;"><i class="fa-solid fa-user-plus" style="color: var(--primary);"></i> Yeni
                Çalışan Ekle</h2>
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="newEmpName" required placeholder="Örn: Ahmet Yılmaz" />
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="tel" id="newEmpPhone" required placeholder="5XX XXX XX XX" />
                </div>
                <div style="display:flex; gap:1rem; margin-top:1.5rem;">
                    <button type="button" onclick="closeAddEmployeeModal()" class="btn"
                        style="background:#f1f5f9; color:var(--dark);">İptal</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" class="modal-overlay" style="display:none;">
        <div class="modal-content card">
            <h2 style="margin-bottom:1.5rem;"><i class="fa-solid fa-pen-to-square" style="color: var(--primary);"></i>
                Çalışan Düzenle</h2>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmpId" />
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="editEmpName" required placeholder="Örn: Ahmet Yılmaz" />
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="tel" id="editEmpPhone" required placeholder="5XX XXX XX XX" />
                </div>
                <div style="display:flex; gap:1rem; margin-top:1.5rem;">
                    <button type="button" onclick="closeEditEmployeeModal()" class="btn"
                        style="background:#f1f5f9; color:var(--dark);">İptal</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Güncelle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="security.js"></script>
    <script src="auth.js"></script>

    <script src="app.js"></script>
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/tr.global.min.js'></script>
    <script src="appointments.js"></script>
    <script src="proposals.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await Auth.checkAuth();
            if (user) {
                document.getElementById('userNameDisplay').textContent = user.company_name || user.username;

                const badge = document.getElementById('trialBadge');
                if (user.is_premium) {
                    badge.style.background = '#dcfce7';
                    badge.style.color = '#166534';
                    badge.innerHTML = '<i class="fa-solid fa-crown"></i> Premium Üyelik';
                } else {
                    const daysLeft = Auth.getDaysLeft(user);
                    if (daysLeft < 0) {
                        badge.style.background = '#fee2e2'; badge.style.color = '#991b1b';
                        badge.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Süre Doldu';
                    } else {
                        badge.innerHTML = `<i
        class="fa-regular fa-clock"></i> ${daysLeft} Gün Kaldı`;
                    }
                }
            }
        });
    </script>

<!-- Slot Modal -->
<div id="slotModal" class="modal-overlay" style="display:none;">
    <div class="modal-content card" style="max-height: 85vh; overflow-y: auto;">
        <h2 style="margin-bottom:1rem;">
            <i class="fa-solid fa-calendar-plus" style="color: var(--primary);"></i> Yeni Zaman Dilimi
        </h2>
        <form id="slotForm">
            <div class="form-group">
                <label>Tarih</label>
                <input type="date" id="slotDate" required />
            </div>
            <div class="form-group">
                <label>Saat</label>
                <input type="time" id="slotTime" required />
            </div>
            <div class="form-group">
                <label>Süre (Dakika)</label>
                <select id="slotDuration" required>
                    <option value="30">30 dakika</option>
                    <option value="60" selected>1 saat</option>
                    <option value="90">1.5 saat</option>
                    <option value="120">2 saat</option>
                </select>
            </div>

            <div style="border-top: 1px solid #e5e7eb; margin: 1rem 0; padding-top: 1rem;">
                <h3 style="font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--primary);">
                    <i class="fa-solid fa-user-pen"></i> Doğrudan Randevu (Opsiyonel)
                </h3>
                <p style="font-size: 0.8rem; color: var(--secondary); margin-bottom: 1rem;">
                    Eğer boş bırakırsanız "Müsait" olarak açılır. Doldurursanız direkt randevu oluşturulur.
                </p>
                <div class="form-group">
                    <label>Müşteri Adı Soyadı</label>
                    <input type="text" id="slotCustomerName" placeholder="Örn: Ayşe Demir" />
                </div>
                <div class="form-group">
                    <label>Müşteri Telefon</label>
                    <input type="tel" id="slotCustomerPhone" placeholder="Örn: 5XX XXX XX XX" />
                </div>
            </div>

            <div style="display:flex; gap:1rem; margin-top:1rem;">
                <button type="button" onclick="closeSlotModal()" class="btn"
                    style="background:#f1f5f9; color:var(--dark);">İptal</button>
                <button type="submit" class="btn btn-primary" style="flex:1;">Ekle</button>
            </div>
        </form>
    </div>
</div>

<!-- Proposal Modal -->
<div id="proposalModal" class="modal-overlay" style="display:none;">
    <div class="modal-content card" style="max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto;">
        <h2 style="margin-bottom:1.5rem; color: #0ea5e9; display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-file-signature"></i> Müşteriye Fiyat Teklifi Oluştur
        </h2>
        <form id="proposalForm">
            <div class="form-group">
                <label style="font-weight: 600; color: #334155;">Müşteri Adı / Firma:</label>
                <input type="text" id="propCustomerName" required placeholder="Örn: Mehmet Demir"
                    style="border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; width: 100%;" />
            </div>
            <div class="form-group">
                <label style="font-weight: 600; color: #334155;">Müşteri WhatsApp Numarası (Opsiyonel):</label>
                <input type="tel" id="propCustomerPhone" placeholder="5XX XXX XX XX"
                    style="border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; width: 100%;" />
            </div>

            <div class="form-group">
                <label style="font-weight: 600; color: #334155;">Teklif Başlığı:</label>
                <input type="text" id="propTitle" required placeholder="Örn: Web Sitesi Tasarımı"
                    style="border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; width: 100%;" />
            </div>

            <div style="margin-top: 20px;">
                <h3 style="font-size: 1.1rem; font-weight: 600; color: #334155; margin-bottom: 10px;">Ürün/Hizmet
                    Kalemleri</h3>

                <div id="proposalItemsContainer" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Dynamic Items will be added here -->
                </div>

                <button type="button" onclick="Proposals.addItem()" class="btn"
                    style="background: #22c55e; color: white; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px;">
                    <i class="fa-solid fa-plus"></i> Yeni Kalem Ekle
                </button>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label style="font-weight: 600; color: #334155;">Ek Notlar:</label>
                <textarea id="propDetails" rows="3" placeholder="Teklif detaylarını buraya yazın..."
                    style="border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; width: 100%;"></textarea>
            </div>

            <div style="text-align: right; margin-top: 20px; font-size: 1.2rem; font-weight: 700; color: #0ea5e9;">
                Toplam Tutar: <span id="propTotalAmount">₺0.00</span>
            </div>

            <div style="display:flex; gap:1rem; margin-top:1.5rem;">
                <button type="button" onclick="closeProposalModal()" class="btn"
                    style="background:#f1f5f9; color:var(--dark);">İptal</button>
                <button type="submit" class="btn btn-primary" style="flex:1;">Teklifi Kaydet</button>
            </div>
        </form>
    </div>
</div>
</body>

</html>
