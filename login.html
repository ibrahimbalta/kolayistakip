<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiriÅŸ Yap - Ä°ÅŸ Takip AsistanÄ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="auth-page">
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <div class="logo" style="justify-content: center; color: var(--primary); margin-bottom: 1rem;">
                    <i class="fa-solid fa-check-double"></i> Kolay Ä°ÅŸ Takip
                </div>
                <p style="color: var(--text-light);">HesabÄ±nÄ±za giriÅŸ yapÄ±n veya yeni hesap oluÅŸturun.</p>
            </div>

            <div class="auth-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">GiriÅŸ Yap</button>
                <button class="tab-btn" onclick="switchTab('register')">KayÄ±t Ol</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label>KullanÄ±cÄ± AdÄ± veya E-posta</label>
                    <input type="text" id="loginUser" required placeholder="KullanÄ±cÄ± adÄ±nÄ±z veya e-posta">
                </div>
                <div class="form-group">
                    <label>Åifre</label>
                    <input type="password" id="loginPass" required placeholder="******">
                </div>
                <div style="text-align: right; margin-bottom: 1rem;">
                    <a href="#" onclick="showForgotPassword(); return false;"
                        style="color: var(--primary); font-size: 0.9rem; text-decoration: none;">
                        Åifremi Unuttum
                    </a>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">GiriÅŸ Yap</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label>Firma AdÄ±</label>
                    <input type="text" id="regCompany" required placeholder="Ã–rn: YÄ±lmaz Ä°nÅŸaat">
                </div>
                <div class="form-group">
                    <label>KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" id="regUser" required placeholder="KullanÄ±cÄ± adÄ±nÄ±z">
                </div>
                <div class="form-group">
                    <label>E-posta Adresi</label>
                    <input type="email" id="regEmail" required placeholder="ornek@firma.com">
                </div>
                <div class="form-group">
                    <label>Åifre</label>
                    <input type="password" id="regPass" required placeholder="GÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in">
                </div>
                <div class="info-box"
                    style="background: #eff6ff; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; color: var(--primary-dark); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-gift"></i> 7 GÃ¼n Ãœcretsiz Deneme BaÅŸlayacak
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">KayÄ±t Ol ve BaÅŸla</button>
            </form>

            <!-- Forgot Password Modal (hidden by default) -->
            <div id="forgotPasswordModal" style="display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--text-dark);">Åifre SÄ±fÄ±rlama</h3>
                <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.9rem;">
                    E-posta adresinizi girin, size ÅŸifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± gÃ¶nderelim.
                </p>
                <form id="forgotPasswordForm" class="auth-form">
                    <div class="form-group">
                        <label>E-posta Adresi</label>
                        <input type="email" id="resetEmail" required placeholder="kayitli@eposta.com">
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" onclick="hideForgotPassword()" class="btn btn-outline"
                            style="flex: 1;">Ä°ptal</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">BaÄŸlantÄ± GÃ¶nder</button>
                    </div>
                </form>
            </div>

            <div class="auth-footer" style="margin-top: 2rem; text-align: center;">
                <a href="index.html" style="color: var(--text-light); font-size: 0.9rem;"><i
                        class="fa-solid fa-arrow-left"></i> Ana Sayfaya DÃ¶n</a>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth.js"></script>
    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('forgotPasswordModal').style.display = 'none';

            if (tab === 'login') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordModal').style.display = 'block';
        }

        function hideForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        // Helper to get redirect URL
        function getRedirectUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect');
            return redirect ? decodeURIComponent(redirect) : null;
        }

        // Check if coming from password reset or has recovery token
        window.addEventListener('DOMContentLoaded', async () => {
            // 1. Check for recovery token in Hash (Supabase default)
            const hash = window.location.hash;
            const urlParams = new URLSearchParams(window.location.search);

            if (hash && hash.includes('type=recovery')) {
                console.log('Recovery token detected');
                // Wait for Supabase to handle the session exchange
                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'PASSWORD_RECOVERY') {
                        // Session established, ask for new password
                        handlePasswordReset();
                    }
                });
            }
            // 2. Check for manual reset param (legacy/manual flow)
            else if (urlParams.get('reset') === 'true') {
                handlePasswordReset();
            }
        });

        async function handlePasswordReset() {
            // Small delay to ensure UI is ready
            setTimeout(async () => {
                const newPass = prompt('ğŸ”’ Åifre SÄ±fÄ±rlama\n\nLÃ¼tfen yeni ÅŸifrenizi girin:');
                if (newPass) {
                    const confirmPass = prompt('ğŸ”’ Onay\n\nLÃ¼tfen yeni ÅŸifrenizi tekrar girin:');
                    if (newPass === confirmPass) {
                        const result = await Auth.updatePassword(newPass);
                        if (result.success) {
                            alert('âœ… ' + result.message);
                            // Clear hash and params
                            window.history.replaceState(null, null, window.location.pathname);
                            window.location.href = 'dashboard.html';
                        } else {
                            alert('âŒ ' + result.message);
                        }
                    } else {
                        alert('âš ï¸ Åifreler eÅŸleÅŸmiyor! LÃ¼tfen tekrar deneyin.');
                        handlePasswordReset(); // Retry
                    }
                }
            }, 500);
        }

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;

            const result = await Auth.login(user, pass);
            if (result.success) {
                const redirect = getRedirectUrl();
                if (redirect) {
                    window.location.href = redirect;
                } else {
                    window.location.href = 'dashboard.html';
                }
            } else {
                alert('âŒ ' + result.message);
            }
        });

        // Register Form
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const company = document.getElementById('regCompany').value;
            const user = document.getElementById('regUser').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;

            // Password Strength Validation
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(pass);
            const hasNumber = /[0-9]/.test(pass);

            if (pass.length < minLength || !hasUpperCase || !hasNumber) {
                alert('âš ï¸ Åifreniz Ã§ok basit!\n\nLÃ¼tfen daha gÃ¼venli bir ÅŸifre oluÅŸturun:\n- En az 8 karakter\n- En az 1 bÃ¼yÃ¼k harf\n- En az 1 rakam iÃ§ermelidir.');
                return;
            }

            const result = await Auth.register(user, pass, company, email);
            if (result.success) {
                alert('âœ… 7 gÃ¼nlÃ¼k deneme sÃ¼reniz baÅŸladÄ±!');

                // Auto login after register
                const loginResult = await Auth.login(user, pass);

                if (loginResult.success) {
                    const redirect = getRedirectUrl();
                    if (redirect) {
                        window.location.href = redirect;
                    } else {
                        window.location.href = 'dashboard.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            } else {
                alert('âŒ ' + result.message);
            }
        });

        // Forgot Password Form
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;

            const result = await Auth.resetPassword(email);
            if (result.success) {
                alert('âœ… ' + result.message);
                hideForgotPassword();
            } else {
                alert('âŒ Hata: ' + result.message);
            }
        });
    </script>
</body>

</html>