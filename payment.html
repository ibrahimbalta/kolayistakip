<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ödeme Yap — Kolay İş Takip</title>

  <!-- TAILWIND -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#4f46e5',
              cyanAccent: '#06b6d4',
              purpleDeep: '#2d064e',
              purpleMid: '#6a1a8c'
            }
          }
        }
      }
  </script>

  <!-- ICONS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background: linear-gradient(135deg,#4b0082 0%,#6a1a8c 100%); }
    .glass{ background:rgba(255,255,255,0.08); backdrop-filter:blur(10px); }
    .card-glow{ box-shadow:0 18px 30px rgba(0,0,0,0.28); }
    @keyframes fadeIn{ from{opacity:0;transform:translateY(12px);} to{opacity:1;transform:none;} }
    .fade{ animation:fadeIn .6s ease both; }
  </style>
</head>
<body class="font-inter text-gray-100 min-h-screen flex flex-col">

<!-- NAVBAR -->
<header class="sticky top-0 bg-black/30 backdrop-blur border-b border-white/10 z-50">
  <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
    <a href="index.html" class="flex items-center gap-3 text-white">
      <span class="p-2 rounded-lg glass card-glow"><i class="fa-solid fa-check-double text-cyanAccent"></i></span>
      <span class="font-semibold text-lg">Kolay İş Takip</span>
    </a>
    <a href="index.html#pricing" class="px-4 py-2 rounded-xl glass text-sm hover:bg-white/10">
      ← Fiyatlara Geri Dön
    </a>
  </div>
</header>

<!-- CONTENT -->
<main class="flex-1 flex justify-center items-center px-4 py-10">
  <div class="glass card-glow border border-white/10 rounded-2xl p-8 w-full max-w-lg fade">

    <!-- TITLE -->
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold">Ödeme İşlemi</h1>
      <p class="text-gray-300 text-sm">Premium üyeliğinizi aktif edin</p>
    </div>

    <!-- SUMMARY -->
    <div class="glass border border-white/10 rounded-xl p-5 mb-6 text-center">
      <div class="text-gray-300 text-sm">ÖDENECEK TUTAR</div>
      <div id="packagePrice" class="text-3xl font-extrabold mt-1 text-cyanAccent">0 TL</div>
      <div id="packageName" class="mt-1 text-gray-300 text-sm">Yükleniyor...</div>
    </div>

    <!-- BANK -->
    <h3 class="text-gray-200 font-semibold mb-3 flex items-center gap-2">
        <i class="fa-solid fa-building-columns text-cyanAccent"></i> Banka Bilgileri
    </h3>

    <div class="glass border border-white/10 rounded-xl p-5 mb-6">
      <div class="flex justify-between text-sm mb-2"><span class="text-gray-300">Banka:</span><span>Akbank</span></div>
      <div class="flex justify-between text-sm mb-2"><span class="text-gray-300">Alıcı:</span><span>İbrahim Balta</span></div>
      <div class="flex justify-between text-sm mb-2"><span class="text-gray-300">Açıklama:</span><span id="paymentDescription">Premium</span></div>

      <div class="mt-4 bg-white/10 rounded-xl flex justify-between items-center px-3 py-2">
        <span class="font-semibold tracking-wide" id="ibanNumber">TR87 0046 0001 3688 8000 1294 17</span>
        <button onclick="copyIBAN()" class="p-2 rounded glass hover:bg-white/20"><i class="fa-regular fa-copy"></i></button>
      </div>
    </div>

    <!-- UPLOAD -->
    <h3 class="text-gray-200 font-semibold mb-3 flex items-center gap-2">
      <i class="fa-solid fa-file-arrow-up text-cyanAccent"></i> Dekont Yükle
    </h3>

    <div id="dropZone" class="glass border border-white/10 rounded-xl p-6 text-center cursor-pointer mb-6">
      <input type="file" id="fileInput" accept="image/*,.pdf" style="display:none" onchange="handleFileSelect(this.files[0])">
      <div id="uploadPrompt">
        <div class="text-4xl text-gray-400 mb-3"><i class="fa-solid fa-cloud-arrow-up"></i></div>
        <div>Dosyayı buraya bırak veya tıkla</div>
        <div class="text-xs text-gray-400 mt-1">PNG, JPG veya PDF (MAX 5MB)</div>
      </div>

      <div id="filePreview" class="hidden text-center mt-3">
        <img id="previewImage" style="max-height:180px;margin:auto;border-radius:12px;">
        <div class="mt-2 text-sm font-semibold text-cyanAccent" id="fileName"></div>
        <button onclick="removeFile(event)" class="mt-2 text-red-300 hover:text-red-400 text-sm">Kaldır</button>
      </div>
    </div>

    <!-- BUTTON -->
    <button id="submitBtn" onclick="submitPayment()" disabled
      class="w-full py-3 rounded-xl bg-gradient-to-r from-cyanAccent to-primary font-semibold hover:scale-[1.02] transition flex items-center justify-center gap-2 shadow-lg">
      <i class="fa-solid fa-check"></i> Ödemeyi Gönder
    </button>

  </div>
</main>


<!-- NOTIFICATION MODAL -->
<div id="notificationModal" class="fixed inset-0 bg-black/50 backdrop-blur-xl hidden justify-center items-center">
  <div class="glass card-glow p-8 rounded-2xl w-full max-w-sm text-center animate-fade">
    <div id="notificationIcon" class="text-4xl mb-4"><i class="fa-solid fa-check-circle text-cyanAccent"></i></div>
    <h2 id="notificationTitle" class="text-xl font-bold mb-2">Başlık</h2>
    <p id="notificationMessage" class="text-gray-300 text-sm mb-6">Mesaj</p>
    <button id="notificationBtn" onclick="closeNotification()" 
      class="w-full py-3 rounded-xl bg-gradient-to-r from-cyanAccent to-primary font-semibold shadow-lg">
      Tamam
    </button>
  </div>
</div>


<!-- SUPABASE - SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth.js"></script>

<script>
let selectedFile=null,currentUser=null,notificationCallback=null;
const url=new URLSearchParams(location.search);
const packageType=url.get("package");
const packageAmount=parseFloat(url.get("amount"));
function showNotification(type,title,msg,cb=null){
  document.getElementById("notificationModal").classList.remove("hidden");
  document.getElementById("notificationTitle").textContent=title;
  document.getElementById("notificationMessage").textContent=msg;
  notificationCallback=cb;
}
function closeNotification(){
  document.getElementById("notificationModal").classList.add("hidden");
  if(notificationCallback){notificationCallback();notificationCallback=null;}
}
document.addEventListener("DOMContentLoaded",async()=>{
  currentUser=await Auth.getCurrentUser();
  if(!currentUser){
    showNotification("warn","Giriş gerekli","Ödeme yapmak için giriş yapmalısınız",()=>{
      location.href=`login.html?redirect=${encodeURIComponent(location.href)}`;
    });
    return;
  }
  document.getElementById("packagePrice").textContent=packageAmount+" TL";
  document.getElementById("packageName").textContent=(packageType==="yearly"?"Yıllık Premium":"Aylık Premium");
  document.getElementById("paymentDescription").textContent=currentUser.username+"—Premium";
});
function copyIBAN(){
  navigator.clipboard.writeText(document.getElementById("ibanNumber").textContent);
  showNotification("ok","Kopyalandı","IBAN numarası panoya kopyalandı.");
}
document.getElementById("dropZone").addEventListener("click",()=>document.getElementById("fileInput").click());
function handleFileSelect(file){
  if(file.size>5*1024*1024){showNotification("err","Hata","Dosya 5MB'dan büyük");return;}
  selectedFile=file;
  document.getElementById("submitBtn").disabled=false;
  document.getElementById("uploadPrompt").style.display="none";
  document.getElementById("filePreview").style.display="block";
  document.getElementById("fileName").textContent=file.name;
  if(file.type.startsWith("image/")){
    let r=new FileReader();
    r.onload=e=>document.getElementById("previewImage").src=e.target.result;
    r.readAsDataURL(file);
  }
}
function removeFile(e){
  e.stopPropagation();
  selectedFile=null;
  document.getElementById("filePreview").style.display="none";
  document.getElementById("uploadPrompt").style.display="block";
  document.getElementById("submitBtn").disabled=true;
}
async function submitPayment(){
  if(!selectedFile){showNotification("err","Uyarı","Dekont yükleyin");return;}
  const btn=document.getElementById("submitBtn");
  btn.disabled=true;btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Gönderiliyor...';
  try{
    const fileExt=selectedFile.name.split('.').pop();
    const fileName=`${currentUser.id}_${Date.now()}.${fileExt}`;
    await supabase.storage.from("payment-receipts").upload(fileName,selectedFile);
    const {data:urlData}=supabase.storage.from("payment-receipts").getPublicUrl(fileName);
    await supabase.from("payment_requests").insert([{
      user_id:currentUser.id,package_type:packageType,amount:packageAmount,payment_proof:urlData.publicUrl,status:"pending"
    }]);
    showNotification("ok","Başarılı","Dekont gönderildi, 24 saat içinde onaylanır.",()=>location.href="dashboard.html");
  }catch(e){
    showNotification("err","Hata","Bir hata oluştu: "+e.message);
    btn.disabled=false;btn.innerHTML="<i class='fa-solid fa-check'></i> Ödemeyi Gönder";
  }
}
</script>

</body>
</html>
